import{connect}from'cloudflare:sockets';const authToken=b(0x1d2);const fallbackAddress=b(0x1d3);const fallbackPort=b(0x1d4);const E_INVALID_DATA=atob(b(0x1d5));const E_INVALID_USER=atob(b(0x1d6));const E_UNSUPPORTED_CMD=atob(b(0x1d7));const E_UDP_DNS_ONLY=atob(b(0x1d8));const E_INVALID_ADDR_TYPE=atob(b(0x1d9));const E_EMPTY_ADDR=atob(b(0x1da));function b(c,d){c=c-0x1d2;const e=a();let f=e[c];return f;}const E_WS_NOT_OPEN=atob(b(0x1db));const E_INVALID_ID_STR=atob(b(0x1dc));const ADDRESS_TYPE_IPV4=0x1;const ADDRESS_TYPE_URL=0x2;function a(){const w=['e258977b-e413-4718-a3af-02d75492c349','tw.x9527.xyz','443','aW52YWxpZCBkYXRh','aW52YWxpZCB1c2Vy','Y29tbWFuZCBpcyBub3Qgc3VwcG9ydGVk','VURQIHByb3h5IG9ubHkgZW5hYmxlIGZvciBETlMgd2hpY2ggaXMgcG9ydCA1Mw==','aW52YWxpZCBhZGRyZXNzVHlwZQ==','YWRkcmVzc1ZhbHVlIGlzIGVtcHR5','d2ViU29ja2V0LmVhZHlTdGF0ZSBpcyBub3Qgb3Blbg==','U3RyaW5naWZpZWQgaWRlbnRpZmllciBpcyBpbnZhbGlk','url','headers','get','Upgrade','websocket','method','GET','pathname','<!DOCTYPE\x20html><html\x20lang=\x22zh-CN\x22><head><meta\x20charset=\x22UTF-8\x22><meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,\x20initial-scale-1.0\x22><title>OK</title><style>body{font-family:-apple-system,BlinkMacSystemFont,\x27Segoe\x20UI\x27,Roboto,Helvetica,Arial,sans-serif;display:flex;justify-content:center;align-items:center;height:100vh;margin:0;background-color:#121212;color:#e0e0e0;text-align:center;}.container{padding:2rem;border-radius:8px;background-color:#1e1e1e;box-shadow:0\x204px\x206px\x20rgba(0,0,0,0.1);}h1{color:#4caf50;}</style></head><body><div\x20class=\x22container\x22><h1>OK</h1><p>www.x-aniu.com</p></div></body></html>','text/html;\x20charset=utf-8','toLowerCase','includes','Not\x20Found','toString','hostname','length','push','所有节点获取失败-请到CF后台查看Worker日志','vless://00000000-0000-0000-0000-000000000000@127.0.0.1:80?encryption=none&security=none&type=ws&host=error.com&path=%2F#','join','text/plain;\x20charset=utf-8','no-store,\x20no-cache,\x20must-revalidate,\x20max-age=0','/?ed=2095','vless','forEach','isp','replace','-WS-TLS','none','tls','randomized','://','-WS','https://ccq.xmma.top/heads/main/transformed_result.csv?token=CCQ','error','[GitHub\x20Source]\x20Failed\x20to\x20fetch\x20new\x20IPs,\x20status:\x20','status','text','trim','split','match','warn','[GitHub\x20Source]\x20Line\x20did\x20not\x20match\x20format:\x20\x22','log','[GitHub\x20Source]\x20Successfully\x20parsed\x20','\x20IPs.','[GitHub\x20Source]\x20Error\x20fetching\x20or\x20parsing\x20new\x20IPs:','name','port','values','accept','sec-websocket-protocol','pipeTo','socket','writable','getWriter','write','releaseLock','slice','catch','WS\x20Stream\x20Error:','closed','finally','Initial\x20connection\x20failed,\x20trying\x20fallback:','byteLength','getUint16','decode','addEventListener','message','enqueue','data','close','readable','readyState','send','arrayBuffer','Readable\x20aborted:','Stream\x20connection\x20error:','8.8.4.4','DNS\x20forward\x20error:\x20','from','charCodeAt','buffer','test'];a=function(){return w;};return a();}const ADDRESS_TYPE_IPV6=0x3;export default{async 'fetch'(c,d,e){try{const f=authToken;const g=new URL(c[b(0x1dd)]);if(c[b(0x1de)][b(0x1df)](b(0x1e0))===b(0x1e1)){return await handleWsRequest(c);}else if(c[b(0x1e2)]===b(0x1e3)){if(g[b(0x1e4)]==='/'){const h=b(0x1e5);return new Response(h,{'status':0xc8,'headers':{'Content-Type':b(0x1e6)}});}if(g[b(0x1e4)][b(0x1e7)]()[b(0x1e8)]('/'+f)){return await handleSubscriptionRequest(c,authToken);}}return new Response(b(0x1e9),{'status':0x194});}catch(i){return new Response(i[b(0x1ea)](),{'status':0x1f4});}}};async function handleSubscriptionRequest(c,d){const e=new URL(c[b(0x1dd)]);const f=[];const g=e[b(0x1eb)];const h=await fetchAndParseNewIPs();if(h[b(0x1ec)]>0x0){f[b(0x1ed)](...generateLinksFromNewIPs(h,d,g));}if(f[b(0x1ec)]===0x0){const j=b(0x1ee);const k=b(0x1ef)+encodeURIComponent(j);f[b(0x1ed)](k);}const i=btoa(f[b(0x1f0)]('\x0a'));return new Response(i,{'headers':{'Content-Type':b(0x1f1),'Cache-Control':b(0x1f2)}});}function generateLinksFromSource(c,d,e){const f=[0x1bb];const g=[];const h=[];const i=encodeURIComponent(b(0x1f3));const j=b(0x1f4);c[b(0x1f5)](k=>{const l=k[b(0x1f6)][b(0x1f7)](/\s/g,'_');const m=k['ip'][b(0x1e8)](':')?'['+k['ip']+']':k['ip'];f[b(0x1f5)](n=>{const o=l+'-'+n+b(0x1f8);const p=new URLSearchParams({'encryption':b(0x1f9),'security':b(0x1fa),'sni':e,'fp':b(0x1fb),'type':'ws','host':e,'path':i});h[b(0x1ed)](j+b(0x1fc)+d+'@'+m+':'+n+'?'+p[b(0x1ea)]()+'#'+encodeURIComponent(o));});g[b(0x1f5)](n=>{const o=l+'-'+n+b(0x1fd);const p=new URLSearchParams({'encryption':b(0x1f9),'security':b(0x1f9),'type':'ws','host':e,'path':i});h[b(0x1ed)](j+b(0x1fc)+d+'@'+m+':'+n+'?'+p[b(0x1ea)]()+'#'+encodeURIComponent(o));});});return h;}async function fetchAndParseNewIPs(){const c=b(0x1fe);let d=[];try{const e=await fetch(c);if(!e['ok']){console[b(0x1ff)](b(0x200)+e[b(0x201)]);return[];}const f=await e[b(0x202)]();const g=f[b(0x203)]()[b(0x1f7)](/\r/g,'')[b(0x204)]('\x0a');const h=/^([^:]+):(\d+)#(.*)$/;for(const i of g){const j=i[b(0x203)]();if(!j)continue;const k=j[b(0x205)](h);if(k){d[b(0x1ed)]({'ip':k[0x1],'port':parseInt(k[0x2],0xa),'name':k[0x3][b(0x203)]()||k[0x1]});}else{console[b(0x206)](b(0x207)+j+'\x22');}}console[b(0x208)](b(0x209)+d[b(0x1ec)]+b(0x20a));return d;}catch(l){console[b(0x1ff)](b(0x20b),l);return[];}}function generateLinksFromNewIPs(c,d,e){const f=[];const g=encodeURIComponent(b(0x1f3));const h=b(0x1f4);c[b(0x1f5)](i=>{const j=i[b(0x20c)];const k=i['ip'][b(0x1e8)](':')?'['+i['ip']+']':i['ip'];const l={'encryption':b(0x1f9),'security':b(0x1fa),'sni':e,'fp':b(0x1fb),'type':'ws','host':e,'path':g};const m=new URLSearchParams(l);f[b(0x1ed)](h+b(0x1fc)+d+'@'+k+':'+i[b(0x20d)]+'?'+m[b(0x1ea)]()+'#'+encodeURIComponent(j));});return f;}async function handleWsRequest(c){const d=new WebSocketPair();const [e,f]=Object[b(0x20e)](d);f[b(0x20f)]();let g={'socket':null};let h=![];const i=c[b(0x1de)][b(0x1df)](b(0x210))||'';const j=makeReadableStream(f,i);j[b(0x211)](new WritableStream({async 'write'(k){if(h)return await forwardUDP(k,f,null);if(g[b(0x212)]){const v=g[b(0x212)][b(0x213)][b(0x214)]();await v[b(0x215)](k);v[b(0x216)]();return;}const {hasError:l,message:m,addressType:n,port:o,hostname:p,rawIndex:q,version:r,isUDP:s}=parseWsPacketHeader(k,authToken);if(l)throw new Error(m);if(s){if(o===0x35)h=!![];else throw new Error(E_UDP_DNS_ONLY);}const t=new Uint8Array([r[0x0],0x0]);const u=k[b(0x217)](q);if(h)return forwardUDP(u,f,t);await forwardTCP(n,p,o,u,f,t,g);}}))[b(0x218)](k=>{console[b(0x208)](b(0x219),k);});return new Response(null,{'status':0x65,'webSocket':e});}async function forwardTCP(c,d,e,f,g,h,i){async function j(l,m){const n=connect({'hostname':l,'port':m});const o=n[b(0x213)][b(0x214)]();await o[b(0x215)](f);o[b(0x216)]();return n;}async function k(){const l=await j(fallbackAddress||d,parseInt(fallbackPort,0xa)||e);i[b(0x212)]=l;l[b(0x21a)][b(0x218)](()=>{})[b(0x21b)](()=>closeSocketQuietly(g));connectStreams(l,g,h,null);}try{const l=await j(d,e);i[b(0x212)]=l;connectStreams(l,g,h,k);}catch(m){console[b(0x208)](b(0x21c),m);k();}}function parseWsPacketHeader(c,d){if(c[b(0x21d)]<0x18)return{'hasError':!![],'message':E_INVALID_DATA};const e=new Uint8Array(c[b(0x217)](0x0,0x1));if(formatIdentifier(new Uint8Array(c[b(0x217)](0x1,0x11)))!==d)return{'hasError':!![],'message':E_INVALID_USER};const f=new Uint8Array(c[b(0x217)](0x11,0x12))[0x0];const g=new Uint8Array(c[b(0x217)](0x12+f,0x13+f))[0x0];let h=![];if(g===0x1){}else if(g===0x2){h=!![];}else{return{'hasError':!![],'message':E_UNSUPPORTED_CMD};}const j=0x13+f;const k=new DataView(c[b(0x217)](j,j+0x2))[b(0x21e)](0x0);let l=j+0x2,m=0x0,n=l+0x1,o='';const p=new Uint8Array(c[b(0x217)](l,n))[0x0];switch(p){case ADDRESS_TYPE_IPV4:m=0x4;o=new Uint8Array(c[b(0x217)](n,n+m))[b(0x1f0)]('.');break;case ADDRESS_TYPE_URL:m=new Uint8Array(c[b(0x217)](n,n+0x1))[0x0];n+=0x1;o=new TextDecoder()[b(0x21f)](c[b(0x217)](n,n+m));break;case ADDRESS_TYPE_IPV6:m=0x10;const q=[];const r=new DataView(c[b(0x217)](n,n+m));for(let s=0x0;s<0x8;s++)q[b(0x1ed)](r[b(0x21e)](s*0x2)[b(0x1ea)](0x10));o=q[b(0x1f0)](':');break;default:return{'hasError':!![],'message':E_INVALID_ADDR_TYPE+':\x20'+p};}if(!o)return{'hasError':!![],'message':E_EMPTY_ADDR+':\x20'+p};return{'hasError':![],'addressType':p,'port':k,'hostname':o,'isUDP':h,'rawIndex':n+m,'version':e};}function makeReadableStream(c,d){let e=![];return new ReadableStream({'start'(f){c[b(0x220)](b(0x221),i=>{if(!e)f[b(0x222)](i[b(0x223)]);});c[b(0x220)](b(0x224),()=>{if(!e){closeSocketQuietly(c);f[b(0x224)]();}});c[b(0x220)](b(0x1ff),i=>f[b(0x1ff)](i));const {earlyData:g,error:h}=base64ToArray(d);if(h)f[b(0x1ff)](h);else if(g)f[b(0x222)](g);},'cancel'(){e=!![];closeSocketQuietly(c);}});}async function connectStreams(c,d,e,f){let g=e,h=![];await c[b(0x225)][b(0x211)](new WritableStream({async 'write'(i,j){h=!![];if(d[b(0x226)]!==0x1)j[b(0x1ff)](E_WS_NOT_OPEN);if(g){d[b(0x227)](await new Blob([g,i])[b(0x228)]());g=null;}else{d[b(0x227)](i);}},'abort'(i){console[b(0x1ff)](b(0x229),i);}}))[b(0x218)](i=>{console[b(0x1ff)](b(0x22a),i);closeSocketQuietly(d);});if(!h&&f)f();}async function forwardUDP(c,d,e){try{const f=connect({'hostname':b(0x22b),'port':0x35});let g=e;const h=f[b(0x213)][b(0x214)]();await h[b(0x215)](c);h[b(0x216)]();await f[b(0x225)][b(0x211)](new WritableStream({async 'write'(i){if(d[b(0x226)]===0x1){if(g){d[b(0x227)](await new Blob([g,i])[b(0x228)]());g=null;}else{d[b(0x227)](i);}}}}));}catch(i){console[b(0x1ff)](b(0x22c)+i[b(0x221)]);}}function base64ToArray(c){if(!c)return{'error':null};try{c=c[b(0x1f7)](/-/g,'+')[b(0x1f7)](/_/g,'/');return{'earlyData':Uint8Array[b(0x22d)](atob(c),d=>d[b(0x22e)](0x0))[b(0x22f)],'error':null};}catch(d){return{'error':d};}}function isValidFormat(c){return/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i[b(0x230)](c);}function closeSocketQuietly(c){try{if(c[b(0x226)]===0x1||c[b(0x226)]===0x2)c[b(0x224)]();}catch(d){}}const hexTable=Array[b(0x22d)]({'length':0x100},(c,d)=>(d+0x100)[b(0x1ea)](0x10)[b(0x217)](0x1));function formatIdentifier(c,d=0x0){const e=(hexTable[c[d]]+hexTable[c[d+0x1]]+hexTable[c[d+0x2]]+hexTable[c[d+0x3]]+'-'+hexTable[c[d+0x4]]+hexTable[c[d+0x5]]+'-'+hexTable[c[d+0x6]]+hexTable[c[d+0x7]]+'-'+hexTable[c[d+0x8]]+hexTable[c[d+0x9]]+'-'+hexTable[c[d+0xa]]+hexTable[c[d+0xb]]+hexTable[c[d+0xc]]+hexTable[c[d+0xd]]+hexTable[c[d+0xe]]+hexTable[c[d+0xf]])[b(0x1e7)]();if(!isValidFormat(e))throw new TypeError(E_INVALID_ID_STR);return e;}